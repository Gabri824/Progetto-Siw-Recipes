<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <title>SiwRecipes - Nuova Ricetta</title>
    <link rel="stylesheet" th:href="@{/css/formRicetta.css}">
</head>

<body>

    <!-- Barra superiore stile login -->
    <div class="form-topbar">
        <div class="form-logo">
            <a th:href="@{/}">
                <img th:src="@{/images/Logo-SiwRecipes.png}" alt="SiwRecipes Logo">
            </a>
        </div>
        <a th:href="@{/elencoRicette}" class="btn-back">TORNA INDIETRO</a>
    </div>

    <div class="form-container">
        <div class="form-card">
            <div class="form-header">
                <h1>Crea una <span class="highlight">Nuova Ricetta</span></h1>
                <p>Condividi la tua creazione culinaria con la community</p>
            </div>

            <form th:action="@{/formRicetta}" th:object="${ricetta}" method="post" enctype="multipart/form-data"
                class="recipe-form">

                <!-- Messaggio di errore -->
                <div th:if="${messaggioErrore}" class="error-message">
                    <span class="error-icon">‚ö†</span>
                    <span th:text="${messaggioErrore}"></span>
                </div>

                <!-- Titolo -->
                <div class="form-group">
                    <label for="titolo">
                        <span class="label-icon">üìù</span> Titolo della Ricetta *
                    </label>
                    <input type="text" id="titolo" th:field="*{titolo}" placeholder="Es. Pasta alla Carbonara" required>
                </div>

                <!-- Immagine -->
                <div class="form-group">
                    <label for="file">
                        <span class="label-icon">üì∑</span> Immagine della Ricetta
                    </label>
                    <input type="file" id="file" name="file" accept="image/*" class="file-input">
                    <p class="input-hint">Formati supportati: JPG, PNG, GIF (max 50MB)</p>
                </div>

                <!-- Descrizione -->
                <div class="form-group">
                    <label for="descrizione">
                        <span class="label-icon">üìñ</span> Descrizione
                    </label>
                    <textarea id="descrizione" th:field="*{descrizione}" rows="3"
                        placeholder="Una breve descrizione della tua ricetta..."></textarea>
                </div>

                <!-- Procedimento -->
                <div class="form-group">
                    <label for="procedimento">
                        <span class="label-icon">üë®‚Äçüç≥</span> Procedimento
                    </label>
                    <textarea id="procedimento" th:field="*{procedimento}" rows="6"
                        placeholder="Descrivi passo dopo passo come preparare la ricetta..."></textarea>
                </div>

                <!-- Tempo di preparazione e Difficolt√† (inline) -->
                <div class="form-row">
                    <div class="form-group half">
                        <label for="tempoPreparazione">
                            <span class="label-icon">‚è±Ô∏è</span> Tempo di Preparazione (minuti)
                        </label>
                        <input type="number" id="tempoPreparazione" th:field="*{tempoPreparazione}" min="1"
                            placeholder="Es. 30">
                    </div>

                    <div class="form-group half">
                        <label for="difficolta">
                            <span class="label-icon">üìä</span> Difficolt√†
                        </label>
                        <select id="difficolta" th:field="*{difficolt√†}">
                            <option value="">Seleziona la difficolt√†</option>
                            <option value="Facile">Facile</option>
                            <option value="Media">Media</option>
                            <option value="Difficile">Difficile</option>
                        </select>
                    </div>
                </div>

                <!-- Categoria -->
                <div class="form-group">
                    <label for="categoria">
                        <span class="label-icon">üçΩÔ∏è</span> Categoria
                    </label>
                    <select id="categoria" th:field="*{categoria}">
                        <option value="">Seleziona una categoria</option>
                        <option value="Antipasti">Antipasti</option>
                        <option value="Primi">Primi Piatti</option>
                        <option value="Secondi">Secondi Piatti</option>
                        <option value="Contorni">Contorni</option>
                        <option value="Dolci">Dolci</option>
                        <option value="Vegetariani">Vegetariani</option>
                        <option value="Vegani">Vegani</option>
                        <option value="Salse">Salse e Condimenti</option>
                    </select>
                </div>

                <!-- Ingredienti -->
                <div class="form-group ingredients-section">
                    <label>
                        <span class="label-icon">ü•ï</span> Ingredienti
                    </label>
                    <div id="ingredienti-container">
                        <!-- Primo ingrediente di default -->
                        <div class="ingrediente-row">
                            <input type="text" name="ingredienti[0].nome" placeholder="Nome ingrediente"
                                class="ingrediente-nome">
                            <input type="number" name="ingredienti[0].quantita" placeholder="Qt√†" step="0.1" min="0"
                                class="ingrediente-quantita">
                            <select name="ingredienti[0].unitaMisura" class="ingrediente-unita">
                                <option value="">Unit√†</option>
                                <option value="g">g</option>
                                <option value="kg">kg</option>
                                <option value="ml">ml</option>
                                <option value="l">l</option>
                                <option value="cucchiai">cucchiai</option>
                                <option value="cucchiaini">cucchiaini</option>
                                <option value="pezzi">pezzi</option>
                                <option value="spicchi">spicchi</option>
                                <option value="q.b.">q.b.</option>
                            </select>
                            <button type="button" class="btn-remove-ingrediente" onclick="rimuoviIngrediente(this)"
                                title="Rimuovi">‚úï</button>
                        </div>
                    </div>
                    <button type="button" class="btn-add-ingrediente" onclick="aggiungiIngrediente()">
                        <span>‚ûï</span> Aggiungi Ingrediente
                    </button>
                </div>

                <!-- Bottoni -->
                <div class="form-actions">
                    <a th:href="@{/elencoRicette}" class="btn btn-secondary">Annulla</a>
                    <button type="submit" class="btn btn-primary">
                        <span class="btn-icon">‚ú®</span> Pubblica Ricetta
                    </button>
                </div>

            </form>
        </div>
    </div>

    <script>
        // Indice per tracciare il numero di ingredienti aggiunti
        // Serve per generare nomi univoci per gli input (es. ingredienti[1].nome)
        let ingredienteIndex = 1;

        /**
         * Funzione per aggiungere una nuova riga di ingredienti
         * Viene chiamata quando si clicca sul pulsante "+ Aggiungi Ingrediente"
         */
        function aggiungiIngrediente() {
            const container = document.getElementById('ingredienti-container');

            // Crea un nuovo div per la riga
            const newRow = document.createElement('div');
            newRow.className = 'ingrediente-row';

            // Inserisce l'HTML per i campi di input
            // Nota l'uso di `ingredienteIndex` nell'attributo name: questo permette a Spring
            // di mappare automaticamente i valori nella lista 'ingredienti' dell'oggetto Ricetta
            newRow.innerHTML = `
                <input type="text" name="ingredienti[${ingredienteIndex}].nome" placeholder="Nome ingrediente" class="ingrediente-nome">
                <input type="number" name="ingredienti[${ingredienteIndex}].quantita" placeholder="Qt√†" step="0.1" min="0" class="ingrediente-quantita">
                <select name="ingredienti[${ingredienteIndex}].unitaMisura" class="ingrediente-unita">
                    <option value="">Unit√†</option>
                    <option value="g">g</option>
                    <option value="kg">kg</option>
                    <option value="ml">ml</option>
                    <option value="l">l</option>
                    <option value="cucchiai">cucchiai</option>
                    <option value="cucchiaini">cucchiaini</option>
                    <option value="pezzi">pezzi</option>
                    <option value="spicchi">spicchi</option>
                    <option value="q.b.">q.b.</option>
                </select>
                <button type="button" class="btn-remove-ingrediente" onclick="rimuoviIngrediente(this)" title="Rimuovi">‚úï</button>
            `;

            // Aggiunge la riga al contenitore
            container.appendChild(newRow);

            // Incrementa l'indice per il prossimo ingrediente
            ingredienteIndex++;

            // Animazione di entrata (fade in + scivolamento dall'alto)
            newRow.style.opacity = '0';
            newRow.style.transform = 'translateY(-10px)';
            setTimeout(() => {
                newRow.style.transition = 'all 0.3s ease';
                newRow.style.opacity = '1';
                newRow.style.transform = 'translateY(0)';
            }, 10);
        }

        /**
         * Funzione per rimuovere una riga di ingredienti
         * @param button Il pulsante che ha scatenato l'evento (la "X")
         */
        function rimuoviIngrediente(button) {
            const container = document.getElementById('ingredienti-container');
            const rows = container.querySelectorAll('.ingrediente-row');

            // Impedisce di cancellare l'ultima riga rimasta
            if (rows.length > 1) {
                // Trova l'elemento padre (la riga intera) del bottone cliccato
                const row = button.closest('.ingrediente-row');

                // Animazione di uscita (fade out + scivolamento a sinistra)
                row.style.transition = 'all 0.3s ease';
                row.style.opacity = '0';
                row.style.transform = 'translateX(-20px)';

                // Attende la fine dell'animazione prima di rimuovere l'elemento dal DOM
                setTimeout(() => {
                    row.remove();
                    // IMPORTANTE: Dopo la rimozione, bisogna rinumerare gli indici
                    // per evitare "buchi" nella lista che Spring non saprebbe gestire
                    rinumeraIngredienti();
                }, 300);
            }
        }

        /**
         * Funzione cruciale per il Data Binding di Spring MVC
         * Riscrive gli indici di tutti gli input presenti (0, 1, 2...)
         * Esempio: se elimino l'ingrediente 1 da una lista di 3, il vecchio 2 diventa il nuovo 1.
         */
        function rinumeraIngredienti() {
            const container = document.getElementById('ingredienti-container');
            const rows = container.querySelectorAll('.ingrediente-row');

            // Itera su tutte le righe presenti
            rows.forEach((row, index) => {
                // Aggiorna gli attributi 'name' con il nuovo indice corretto
                row.querySelector('.ingrediente-nome').name = `ingredienti[${index}].nome`;
                row.querySelector('.ingrediente-quantita').name = `ingredienti[${index}].quantita`;
                row.querySelector('.ingrediente-unita').name = `ingredienti[${index}].unitaMisura`;
            });

            // Aggiorna il contatore globale per le future aggiunte
            ingredienteIndex = rows.length;
        }
    </script>

</body>

</html>