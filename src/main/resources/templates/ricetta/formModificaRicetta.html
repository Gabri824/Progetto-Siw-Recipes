<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <title>SiwRecipes - Modifica Ricetta</title>
    <link rel="stylesheet" th:href="@{/css/formRicetta.css}">
</head>

<body>

    <!-- Barra superiore stile login -->
    <div class="form-topbar">
        <div class="form-logo">
            <a th:href="@{/}">
                <img th:src="@{/images/Logo-SiwRecipes.png}" alt="SiwRecipes Logo">
            </a>
        </div>
        <a th:href="@{/ricetta/{id}(id=${ricetta.id})}" class="btn-back">TORNA INDIETRO</a>
    </div>

    <div class="form-container">
        <div class="form-card">
            <div class="form-header">
                <h1>Modifica <span class="highlight">Ricetta</span></h1>
                <p>Aggiorna i dettagli della tua ricetta</p>
            </div>

            <form th:action="@{/ricetta/edit/{id}(id=${ricetta.id})}" th:object="${ricetta}" method="post"
                enctype="multipart/form-data" class="recipe-form">

                <!-- Messaggio di errore -->
                <div th:if="${messaggioErrore}" class="error-message">
                    <span class="error-icon">‚ö†</span>
                    <span th:text="${messaggioErrore}"></span>
                </div>

                <!-- Titolo -->
                <div class="form-group">
                    <label for="titolo">
                        <span class="label-icon">üìù</span> Titolo della Ricetta *
                    </label>
                    <input type="text" id="titolo" th:field="*{titolo}" placeholder="Es. Pasta alla Carbonara" required>
                </div>

                <!-- Immagine -->
                <div class="form-group">
                    <label for="file">
                        <span class="label-icon">üì∑</span> Immagine della Ricetta
                    </label>
                    <!-- Anteprima immagine corrente -->
                    <div th:if="${ricetta.immagine != null}" class="image-preview-container">
                        <span class="current-image-label">Immagine attuale:</span>
                        <img th:src="@{/ricetta/{id}/immagine(id=${ricetta.id})}" alt="Immagine attuale"
                            class="current-image-preview">
                    </div>
                    <input type="file" id="file" name="file" accept="image/*" class="file-input">
                    <p class="input-hint">Carica una nuova immagine per sostituire quella attuale (JPG, PNG, GIF - max
                        50MB)</p>
                </div>

                <!-- Descrizione -->
                <div class="form-group">
                    <label for="descrizione">
                        <span class="label-icon">üìñ</span> Descrizione
                    </label>
                    <textarea id="descrizione" th:field="*{descrizione}" rows="3"
                        placeholder="Una breve descrizione della tua ricetta..."></textarea>
                </div>

                <!-- Procedimento -->
                <div class="form-group">
                    <label for="procedimento">
                        <span class="label-icon">üë®‚Äçüç≥</span> Procedimento
                    </label>
                    <textarea id="procedimento" th:field="*{procedimento}" rows="6"
                        placeholder="Descrivi passo dopo passo come preparare la ricetta..."></textarea>
                </div>

                <!-- Tempo di preparazione e Difficolt√† (inline) -->
                <div class="form-row">
                    <div class="form-group half">
                        <label for="tempoPreparazione">
                            <span class="label-icon">‚è±Ô∏è</span> Tempo di Preparazione (minuti)
                        </label>
                        <input type="number" id="tempoPreparazione" th:field="*{tempoPreparazione}" min="1"
                            placeholder="Es. 30">
                    </div>

                    <div class="form-group half">
                        <label for="difficolta">
                            <span class="label-icon">üìä</span> Difficolt√†
                        </label>
                        <select id="difficolta" th:field="*{difficolt√†}">
                            <option value="">Seleziona la difficolt√†</option>
                            <option value="Facile">Facile</option>
                            <option value="Media">Media</option>
                            <option value="Difficile">Difficile</option>
                        </select>
                    </div>
                </div>

                <!-- Categoria -->
                <div class="form-group">
                    <label for="categoria">
                        <span class="label-icon">üçΩÔ∏è</span> Categoria
                    </label>
                    <select id="categoria" th:field="*{categoria}">
                        <option value="">Seleziona una categoria</option>
                        <option value="Antipasti">Antipasti</option>
                        <option value="Primi">Primi Piatti</option>
                        <option value="Secondi">Secondi Piatti</option>
                        <option value="Contorni">Contorni</option>
                        <option value="Dolci">Dolci</option>
                        <option value="Vegetariani">Vegetariani</option>
                        <option value="Vegani">Vegani</option>
                        <option value="Salse">Salse e Condimenti</option>
                    </select>
                </div>

                <!-- Ingredienti -->
                <div class="form-group ingredients-section">
                    <label>
                        <span class="label-icon">ü•ï</span> Ingredienti
                    </label>
                    <div id="ingredienti-container">
                        <!-- Ingredienti esistenti caricati dinamicamente -->
                        <th:block th:each="ingrediente, iterStat : ${ricetta.ingredienti}">
                            <div class="ingrediente-row">
                                <input type="text" th:name="'ingredienti[' + ${iterStat.index} + '].nome'"
                                    th:value="${ingrediente.nome}" placeholder="Nome ingrediente"
                                    class="ingrediente-nome">
                                <input type="number" th:name="'ingredienti[' + ${iterStat.index} + '].quantita'"
                                    th:value="${ingrediente.quantita}" placeholder="Qt√†" step="0.1" min="0"
                                    class="ingrediente-quantita">
                                <select th:name="'ingredienti[' + ${iterStat.index} + '].unitaMisura'"
                                    class="ingrediente-unita">
                                    <option value="">Unit√†</option>
                                    <option value="g" th:selected="${ingrediente.unitaMisura == 'g'}">g</option>
                                    <option value="kg" th:selected="${ingrediente.unitaMisura == 'kg'}">kg</option>
                                    <option value="ml" th:selected="${ingrediente.unitaMisura == 'ml'}">ml</option>
                                    <option value="l" th:selected="${ingrediente.unitaMisura == 'l'}">l</option>
                                    <option value="cucchiai" th:selected="${ingrediente.unitaMisura == 'cucchiai'}">
                                        cucchiai</option>
                                    <option value="cucchiaini" th:selected="${ingrediente.unitaMisura == 'cucchiaini'}">
                                        cucchiaini</option>
                                    <option value="pezzi" th:selected="${ingrediente.unitaMisura == 'pezzi'}">pezzi
                                    </option>
                                    <option value="spicchi" th:selected="${ingrediente.unitaMisura == 'spicchi'}">
                                        spicchi</option>
                                    <option value="q.b." th:selected="${ingrediente.unitaMisura == 'q.b.'}">q.b.
                                    </option>
                                </select>
                                <button type="button" class="btn-remove-ingrediente" onclick="rimuoviIngrediente(this)"
                                    title="Rimuovi">‚úï</button>
                            </div>
                        </th:block>

                        <!-- Riga di default se non ci sono ingredienti -->
                        <div class="ingrediente-row" th:if="${#lists.isEmpty(ricetta.ingredienti)}">
                            <input type="text" name="ingredienti[0].nome" placeholder="Nome ingrediente"
                                class="ingrediente-nome">
                            <input type="number" name="ingredienti[0].quantita" placeholder="Qt√†" step="0.1" min="0"
                                class="ingrediente-quantita">
                            <select name="ingredienti[0].unitaMisura" class="ingrediente-unita">
                                <option value="">Unit√†</option>
                                <option value="g">g</option>
                                <option value="kg">kg</option>
                                <option value="ml">ml</option>
                                <option value="l">l</option>
                                <option value="cucchiai">cucchiai</option>
                                <option value="cucchiaini">cucchiaini</option>
                                <option value="pezzi">pezzi</option>
                                <option value="spicchi">spicchi</option>
                                <option value="q.b.">q.b.</option>
                            </select>
                            <button type="button" class="btn-remove-ingrediente" onclick="rimuoviIngrediente(this)"
                                title="Rimuovi">‚úï</button>
                        </div>
                    </div>
                    <button type="button" class="btn-add-ingrediente" onclick="aggiungiIngrediente()">
                        <span>‚ûï</span> Aggiungi Ingrediente
                    </button>
                </div>

                <!-- Bottoni -->
                <div class="form-actions">
                    <a th:href="@{/ricetta/{id}(id=${ricetta.id})}" class="btn btn-secondary">Annulla</a>
                    <button type="submit" class="btn btn-primary">
                        <span class="btn-icon">üíæ</span> Salva Modifiche
                    </button>
                </div>

            </form>
        </div>
    </div>

    <script th:inline="javascript">
        /*
         * Inizializzazione dell'indice:
         * A differenza della pagina di creazione, qui potremmo avere gi√† degli ingredienti salvati.
         * Usiamo Thymeleaf (th:inline="javascript") per calcolare lato server quanti ingredienti ci sono.
         * Se la lista √® vuota, partiamo da 1 (perch√© nel DOM c'√® sempre almeno una riga vuota o piena).
         * Altrimenti, partiamo dalla dimensione della lista esistente.
         */
        let ingredienteIndex = /*[[${#lists.isEmpty(ricetta.ingredienti) ? 1 : ricetta.ingredienti.size()}]]*/ 1;

        /**
         * Funzione per aggiungere una nuova riga di ingredienti
         * Identica a quella di creazione: crea HTML dinamico e lo appende al container.
         */
        function aggiungiIngrediente() {
            const container = document.getElementById('ingredienti-container');

            // Crea il contenitore della riga
            const newRow = document.createElement('div');
            newRow.className = 'ingrediente-row';

            // Definisce l'HTML interno con gli input corretti
            // L'attributo 'name' deve seguire lo schema ingredienti[INDICE].campo
            // affinch√© Spring possa legare i dati all'oggetto Ricetta al submit
            newRow.innerHTML = `
                <input type="text" name="ingredienti[${ingredienteIndex}].nome" placeholder="Nome ingrediente" class="ingrediente-nome">
                <input type="number" name="ingredienti[${ingredienteIndex}].quantita" placeholder="Qt√†" step="0.1" min="0" class="ingrediente-quantita">
                <select name="ingredienti[${ingredienteIndex}].unitaMisura" class="ingrediente-unita">
                    <option value="">Unit√†</option>
                    <option value="g">g</option>
                    <option value="kg">kg</option>
                    <option value="ml">ml</option>
                    <option value="l">l</option>
                    <option value="cucchiai">cucchiai</option>
                    <option value="cucchiaini">cucchiaini</option>
                    <option value="pezzi">pezzi</option>
                    <option value="spicchi">spicchi</option>
                    <option value="q.b.">q.b.</option>
                </select>
                <button type="button" class="btn-remove-ingrediente" onclick="rimuoviIngrediente(this)" title="Rimuovi">‚úï</button>
            `;

            // Aggiunge al DOM
            container.appendChild(newRow);

            // Incrementa il contatore per il prossimo inserimento
            ingredienteIndex++;

            // Gestisce l'animazione di comparsa
            newRow.style.opacity = '0';
            newRow.style.transform = 'translateY(-10px)';
            setTimeout(() => {
                newRow.style.transition = 'all 0.3s ease';
                newRow.style.opacity = '1';
                newRow.style.transform = 'translateY(0)';
            }, 10);
        }

        /**
         * Rimuove una riga specifica e aggiorna gli indici
         */
        function rimuoviIngrediente(button) {
            const container = document.getElementById('ingredienti-container');
            const rows = container.querySelectorAll('.ingrediente-row');

            // Controllo di sicurezza: non rimuovere l'unica riga rimasta
            if (rows.length > 1) {
                const row = button.closest('.ingrediente-row');

                // Animazione di uscita
                row.style.transition = 'all 0.3s ease';
                row.style.opacity = '0';
                row.style.transform = 'translateX(-20px)';

                // Rimozione effettiva dopo l'animazione
                setTimeout(() => {
                    row.remove();
                    // Fondamentale: ricalcola tutti gli indici per mantenere la lista coerente per Spring
                    rinumeraIngredienti();
                }, 300);
            }
        }

        /**
         * Rinumera gli attributi 'name' di tutti gli input visible.
         * Questo assicura che se rimuoviamo l'elemento intermedio,
         * la lista inviata al server sia contigua (es. 0, 1, 2) e non frammentata (0, 2).
         * Spring MVC richiede liste contigue per il binding automatico.
         */
        function rinumeraIngredienti() {
            const container = document.getElementById('ingredienti-container');
            const rows = container.querySelectorAll('.ingrediente-row');

            rows.forEach((row, index) => {
                // Aggiorna nome, quantit√† e unit√† di misura con il nuovo indice
                row.querySelector('.ingrediente-nome').name = `ingredienti[${index}].nome`;
                row.querySelector('.ingrediente-quantita').name = `ingredienti[${index}].quantita`;
                row.querySelector('.ingrediente-unita').name = `ingredienti[${index}].unitaMisura`;
            });

            // Sincronizza il contatore globale con il numero attuale di righe
            ingredienteIndex = rows.length;
        }
    </script>

</body>

</html>